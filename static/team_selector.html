<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Team Selector - LEDMatrix</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .main-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* KC Favorites Section */
        .kc-favorites {
            background: linear-gradient(135deg, #E31837 0%, #FFB81C 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .kc-favorites h2 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kc-favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .kc-favorite-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .kc-favorite-card:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .kc-favorite-card.selected {
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
        }

        .kc-favorite-card input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .kc-favorite-card label {
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
        }

        /* League Tabs */
        .league-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .league-tab {
            padding: 12px 24px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .league-tab:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .league-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Rankings Section - College Themed */
        .rankings-section {
            background: linear-gradient(135deg, #1e3a5f 0%, #c85a17 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            color: white;
            display: none;
        }

        .rankings-section.visible {
            display: block;
        }

        .rankings-section h3 {
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rankings-description {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .rankings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .ranking-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.25);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .ranking-card.selected {
            background: rgba(255, 255, 255, 0.35);
            border-color: white;
        }

        .ranking-card.cfp-only {
            display: none;
        }

        .ranking-card.cfp-only.visible {
            display: flex;
        }

        .ranking-card input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .ranking-card label {
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        /* Search Box */
        .search-section {
            margin-bottom: 25px;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .search-box button:hover {
            background: #5568d3;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }

        .filter-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Teams Grid */
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .team-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .team-card:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .team-card.selected {
            background: #ebf4ff;
            border-color: #667eea;
        }

        .team-card input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .team-info {
            flex: 1;
        }

        .team-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .team-details {
            font-size: 12px;
            color: #718096;
        }

        .anti-spoiler-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #c53030;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .anti-spoiler-toggle:hover {
            background: #fed7d7;
        }

        .anti-spoiler-toggle.active {
            background: #c53030;
            color: white;
            border-color: #c53030;
        }

        .anti-spoiler-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
        }

        .team-color-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stats Summary */
        .stats-summary {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(72, 187, 120, 0.5);
            font-weight: 600;
            font-size: 16px;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 9999;
            pointer-events: none;
        }

        .success-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }

            .league-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .teams-grid {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üéØ Enhanced Team Selector</h1>
                <p>Select your favorite teams and configure anti-spoiler settings</p>
            </div>
            <a href="/" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; text-decoration: none;">
                <span style="font-size: 1.2rem;">‚Üê</span> Back to Main
            </a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- KC Favorites -->
            <div class="kc-favorites">
                <h2>‚≠ê Quick Picks - Kansas City Favorites</h2>
                <div id="kcFavorites" class="kc-favorites-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="stats-summary">
                <div class="stat-item">
                    <div id="totalTeams" class="stat-value">0</div>
                    <div class="stat-label">Total Teams</div>
                </div>
                <div class="stat-item">
                    <div id="selectedCount" class="stat-value">0</div>
                    <div class="stat-label">Selected</div>
                </div>
                <div class="stat-item">
                    <div id="leagueCount" class="stat-value">0</div>
                    <div class="stat-label">Leagues</div>
                </div>
            </div>

            <!-- Actions (Top) -->
            <div class="actions" style="margin-bottom: 25px;">
                <button class="btn btn-primary" onclick="saveSelection()">üíæ Save Selection</button>
                <button class="btn btn-secondary" onclick="resetSelection()">üîÑ Reset All</button>
            </div>

            <!-- League Tabs -->
            <div id="leagueTabs" class="league-tabs">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Rankings Section (NCAA only) -->
            <div id="rankingsSection" class="rankings-section">
                <h3>üèÜ <span id="rankingsTitle">College Rankings</span></h3>
                <p class="rankings-description">
                    Select rankings to automatically follow all teams in that poll. These expand at runtime.
                </p>
                <div class="rankings-grid">
                    <div class="ranking-card" onclick="toggleRanking('AP_TOP_25')">
                        <input type="checkbox" id="ranking_AP_TOP_25">
                        <label for="ranking_AP_TOP_25">AP Top 25</label>
                    </div>
                    <div class="ranking-card" onclick="toggleRanking('AP_TOP_10')">
                        <input type="checkbox" id="ranking_AP_TOP_10">
                        <label for="ranking_AP_TOP_10">AP Top 10</label>
                    </div>
                    <div class="ranking-card cfp-only" onclick="toggleRanking('CFP_TOP_12')">
                        <input type="checkbox" id="ranking_CFP_TOP_12">
                        <label for="ranking_CFP_TOP_12">CFP Top 12</label>
                    </div>
                    <div class="ranking-card cfp-only" onclick="toggleRanking('CFP_TOP_25')">
                        <input type="checkbox" id="ranking_CFP_TOP_25">
                        <label for="ranking_CFP_TOP_25">CFP Top 25</label>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search teams by name, location, or abbreviation...">
                    <button onclick="searchTeams()">Search</button>
                </div>
            </div>

            <!-- Filters -->
            <div id="filtersSection" class="filters" style="display: none;">
                <div class="filter-group">
                    <label>Conference</label>
                    <select id="conferenceFilter" onchange="applyFilters()">
                        <option value="">All Conferences</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Division</label>
                    <select id="divisionFilter" onchange="applyFilters()">
                        <option value="">All Divisions</option>
                    </select>
                </div>
            </div>

            <!-- Teams Container -->
            <div id="teamsContainer" class="teams-grid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading teams...</p>
                </div>
            </div>

            <!-- Actions (Bottom) -->
            <div class="actions">
                <button class="btn btn-primary" onclick="saveSelection()">üíæ Save Selection</button>
                <button class="btn btn-secondary" onclick="resetSelection()">üîÑ Reset All</button>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message"></div>

    <script>
        // Global state
        let allTeams = {};
        let selectedTeams = new Set();
        let antiSpoilerTeams = new Set();
        let currentLeague = 'nfl';
        let currentTeams = [];
        let displayedTeams = [];
        let soccerTeams = {};
        let soccerLoaded = false;
        let selectedSoccerLeague = 'all';
        let expandedCategories = new Set(['us_professional']);

        // Rankings state - tracks which ranking tokens are selected per league
        // Keys match the JSON/API league keys (ncaamb, ncaawb, ncaa_fb)
        let selectedRankings = {
            ncaa_fb: new Set(),
            ncaamb: new Set(),
            ncaawb: new Set()
        };

        // Rankings that apply to each league (keys match JSON/API)
        const RANKINGS_BY_LEAGUE = {
            ncaa_fb: ['AP_TOP_25', 'AP_TOP_10', 'CFP_TOP_12', 'CFP_TOP_25'],
            ncaamb: ['AP_TOP_25', 'AP_TOP_10'],
            ncaawb: ['AP_TOP_25', 'AP_TOP_10']
        };

        // Display names for league tabs (key -> friendly name)
        const LEAGUE_DISPLAY_NAMES = {
            nfl: 'NFL',
            mlb: 'MLB',
            nba: 'NBA',
            nhl: 'NHL',
            wnba: 'WNBA',
            ncaa_fb: 'NCAA Football',
            ncaamb: "NCAA Men's Basketball",
            ncaawb: "NCAA Women's Basketball",
            ncaa_baseball: 'NCAA Baseball',
            ncaam_hockey: "NCAA Men's Hockey",
            ncaaw_hockey: "NCAA Women's Hockey",
            ncaamsoc: "NCAA Men's Soccer",
            ncaawsoc: "NCAA Women's Soccer",
            mls: 'MLS'  // Hidden but mapped for reference
        };

        // Leagues to hide from tabs (already included in Soccer tab or other reasons)
        const HIDDEN_LEAGUES = ['mls'];

        // Sort order for league tabs (leagues not listed will appear at end alphabetically)
        const LEAGUE_SORT_ORDER = [
            // Pro Sports
            'nfl',
            'mlb',
            'nba',
            'nhl',
            'wnba',
            // College Football
            'ncaa_fb',
            // College Basketball
            'ncaamb',
            'ncaawb',
            // College Baseball
            'ncaa_baseball',
            // College Hockey
            'ncaam_hockey',
            'ncaaw_hockey',
            // College Soccer
            'ncaamsoc',
            'ncaawsoc'
        ];

        // Map from uppercase saved format to lowercase state key
        // These are the prefixes used when SAVING to config
        const LEAGUE_PREFIX_MAP = {
            'NCAA_FB': 'ncaa_fb',
            'NCAAMB': 'ncaamb',
            'NCAAWB': 'ncaawb'
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Load saved selections FIRST (before team data)
            await loadSavedSelections();
            // Then load team data (which will use the loaded selections)
            await loadTeamData();
            // Load soccer in background (don't block)
            loadSoccerTeams();
        });

        // ============================================
        // BUG FIX: Complete loadSavedSelections with proper ranking parsing
        // ============================================
        async function loadSavedSelections() {
            try {
                const response = await fetch('/api/teams/saved');
                const data = await response.json();

                console.log('Loaded saved selections:', data);

                if (data.teams) {
                    data.teams.forEach(item => {
                        // Check if it's a ranking token by looking for known patterns
                        // Ranking tokens are stored as: NCAA_FB_AP_TOP_25, NCAAMB_AP_TOP_10, etc.
                        let isRanking = false;
                        
                        for (const [prefix, leagueKey] of Object.entries(LEAGUE_PREFIX_MAP)) {
                            // Check patterns like NCAA_FB_AP_TOP_25
                            if (item.startsWith(prefix + '_AP_TOP_') || item.startsWith(prefix + '_CFP_TOP_')) {
                                // Extract the ranking token (everything after the league prefix)
                                const rankingToken = item.substring(prefix.length + 1); // +1 for the underscore
                                selectedRankings[leagueKey].add(rankingToken);
                                console.log(`Parsed ranking: ${item} -> ${leagueKey}.add('${rankingToken}')`);
                                isRanking = true;
                                break;
                            }
                        }
                        
                        if (!isRanking) {
                            // It's a regular team
                            selectedTeams.add(item);
                        }
                    });
                }

                if (data.anti_spoiler_teams) {
                    data.anti_spoiler_teams.forEach(team => {
                        antiSpoilerTeams.add(team);
                    });
                }

                console.log('Parsed rankings state:', {
                    ncaa_fb: Array.from(selectedRankings.ncaa_fb),
                    ncaamb: Array.from(selectedRankings.ncaamb),
                    ncaawb: Array.from(selectedRankings.ncaawb)
                });

            } catch (error) {
                console.error('Error loading saved selections:', error);
            }
        }

        // Load team data
        async function loadTeamData() {
            try {
                const response = await fetch('/api/teams/all');
                allTeams = await response.json();

                initializeLeagueTabs();
                updateStats();
                loadKCFavorites();
                loadLeague('nfl');

            } catch (error) {
                console.error('Error loading team data:', error);
                document.getElementById('teamsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Error loading teams</h3>
                        <p>Please refresh the page</p>
                    </div>
                `;
            }
        }

        // Load soccer teams
        async function loadSoccerTeams() {
            try {
                const response = await fetch('/api/teams/soccer');
                const result = await response.json();
                
                if (result.status === 'success') {
                    soccerTeams = result.data;
                    soccerLoaded = true;
                    console.log('Soccer teams loaded:', soccerTeams);
                } else {
                    console.error('Failed to load soccer teams:', result.message);
                }
            } catch (error) {
                console.error('Error loading soccer teams:', error);
            }
        }

        // Initialize league tabs
        function initializeLeagueTabs() {
            const leagues = Object.keys(allTeams)
                .filter(k => k !== 'kc_favorites' && k !== '_metadata')
                .filter(k => !HIDDEN_LEAGUES.includes(k))
                .sort((a, b) => {
                    // Sort by custom order, unknowns go to end
                    const aIndex = LEAGUE_SORT_ORDER.indexOf(a);
                    const bIndex = LEAGUE_SORT_ORDER.indexOf(b);
                    const aOrder = aIndex === -1 ? 999 : aIndex;
                    const bOrder = bIndex === -1 ? 999 : bIndex;
                    return aOrder - bOrder;
                });
            
            const tabsHtml = leagues.map(league => {
                const displayName = LEAGUE_DISPLAY_NAMES[league] || league.toUpperCase();
                return `
                    <div class="league-tab ${league === 'nfl' ? 'active' : ''}"
                         data-league="${league}"
                         onclick="switchLeague('${league}')">
                        ${displayName}
                    </div>
                `;
            }).join('');

            document.getElementById('leagueTabs').innerHTML = tabsHtml + 
                '<div class="league-tab" data-league="soccer" onclick="switchToSoccer()">Pro Soccer</div>';
        }

        // Switch league
        function switchLeague(league) {
            currentLeague = league;

            // Update active tab using data-league attribute
            document.querySelectorAll('.league-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.league === league) {
                    tab.classList.add('active');
                }
            });

            // Update rankings section visibility
            updateRankingsSection();

            loadLeague(league);
        }

        // ============================================
        // Rankings Section UI Management
        // ============================================
        function updateRankingsSection() {
            const rankingsSection = document.getElementById('rankingsSection');
            const cfpCards = document.querySelectorAll('.cfp-only');
            
            // NCAA leagues that support rankings (keys match JSON/API)
            const ncaaLeagues = ['ncaa_fb', 'ncaamb', 'ncaawb'];
            
            if (ncaaLeagues.includes(currentLeague)) {
                rankingsSection.classList.add('visible');
                
                // Update title based on league
                const titles = {
                    ncaa_fb: 'College Football Rankings',
                    ncaamb: "Men's Basketball Rankings",
                    ncaawb: "Women's Basketball Rankings"
                };
                document.getElementById('rankingsTitle').textContent = titles[currentLeague] || 'Rankings';
                
                // Show/hide CFP options (football only)
                const showCFP = currentLeague === 'ncaa_fb';
                cfpCards.forEach(card => {
                    card.classList.toggle('visible', showCFP);
                });
                
                // BUG FIX: Update checkbox states for this league
                updateRankingsCheckboxes();
            } else {
                rankingsSection.classList.remove('visible');
            }
        }

        // ============================================
        // BUG FIX: Properly sync checkbox states with selectedRankings
        // ============================================
        function updateRankingsCheckboxes() {
            const leagueRankings = selectedRankings[currentLeague] || new Set();
            
            console.log(`updateRankingsCheckboxes for ${currentLeague}:`, Array.from(leagueRankings));
            
            // Update all ranking checkboxes
            ['AP_TOP_25', 'AP_TOP_10', 'CFP_TOP_12', 'CFP_TOP_25'].forEach(token => {
                const checkbox = document.getElementById(`ranking_${token}`);
                const card = checkbox?.closest('.ranking-card');
                
                if (checkbox) {
                    const isSelected = leagueRankings.has(token);
                    checkbox.checked = isSelected;
                    
                    if (card) {
                        card.classList.toggle('selected', isSelected);
                    }
                    
                    console.log(`  ${token}: ${isSelected ? 'CHECKED' : 'unchecked'}`);
                }
            });
        }

        // Toggle ranking selection
        function toggleRanking(token) {
            const checkbox = document.getElementById(`ranking_${token}`);
            const card = checkbox?.closest('.ranking-card');
            const leagueRankings = selectedRankings[currentLeague];
            
            if (!leagueRankings) return;
            
            if (leagueRankings.has(token)) {
                leagueRankings.delete(token);
                if (checkbox) checkbox.checked = false;
                if (card) card.classList.remove('selected');
            } else {
                leagueRankings.add(token);
                if (checkbox) checkbox.checked = true;
                if (card) card.classList.add('selected');
            }
            
            console.log(`Toggled ${token} for ${currentLeague}:`, Array.from(leagueRankings));
            updateStats();
        }

        // Load league teams
        function loadLeague(league) {
            currentLeague = league;
            const leagueData = allTeams[league];

            if (!leagueData || !leagueData.teams) {
                document.getElementById('teamsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>No teams found</h3>
                    </div>
                `;
                return;
            }

            currentTeams = leagueData.teams;

            // Show/hide filters based on league
            const hasConference = currentTeams.some(t => t.conference);
            document.getElementById('filtersSection').style.display = hasConference ? 'flex' : 'none';

            if (hasConference) {
                populateFilters();
            }

            applyFilters();
        }

        // Populate conference/division filters
        function populateFilters() {
            const conferences = [...new Set(currentTeams.map(t => t.conference).filter(Boolean))];
            const divisions = [...new Set(currentTeams.map(t => t.division).filter(Boolean))];

            document.getElementById('conferenceFilter').innerHTML =
                '<option value="">All Conferences</option>' +
                conferences.map(c => `<option value="${c}">${c}</option>`).join('');

            document.getElementById('divisionFilter').innerHTML =
                '<option value="">All Divisions</option>' +
                divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        // Apply filters
        function applyFilters() {
            const conference = document.getElementById('conferenceFilter').value;
            const division = document.getElementById('divisionFilter').value;

            let filtered = currentTeams;

            if (conference) {
                filtered = filtered.filter(t => t.conference === conference);
            }

            if (division) {
                filtered = filtered.filter(t => t.division === division);
            }

            renderTeams(filtered);
        }

        // Render teams
        function renderTeams(teams) {
            displayedTeams = teams;
            const html = teams.map(team => {
                const teamId = `${currentLeague.toUpperCase()}_${team.id}`;
                const isSelected = selectedTeams.has(teamId);
                const isAntiSpoiler = antiSpoilerTeams.has(teamId);

                return `
                    <div class="team-card ${isSelected ? 'selected' : ''}"
                         onclick="toggleTeam('${currentLeague}', '${team.id}')">
                        <input type="checkbox" id="team_${teamId}" ${isSelected ? "checked" : ""} onclick="toggleTeam('${currentLeague}', '${team.id}'); event.stopPropagation();">
                        <div class="team-info">
                            <div class="team-name">${team.display_name}</div>
                            <div class="team-details">
                                ${team.location} ‚Ä¢ ${team.conference || ''} ${team.division || ''}
                            </div>
                        </div>
                        ${isSelected ? `
                            <div class="anti-spoiler-toggle ${isAntiSpoiler ? 'active' : ''}"
                                 onclick="toggleAntiSpoiler('${currentLeague}', '${team.id}', event)">
                                <input type="checkbox"
                                       ${isAntiSpoiler ? 'checked' : ''}
                                       onclick="toggleAntiSpoiler('${currentLeague}', '${team.id}', event); event.stopPropagation()">
                                <span>üôà Hide</span>
                            </div>
                        ` : ''}
                        <div class="team-color-indicator"
                             style="background: ${team.primary_color}"></div>
                    </div>
                `;
            }).join('');

            document.getElementById('teamsContainer').innerHTML =
                html || '<div class="empty-state"><div class="empty-state-icon">üì¶</div><h3>No teams match your filters</h3></div>';
        }

        // Toggle team selection
        function toggleTeam(league, teamId) {
            const fullId = `${league.toUpperCase()}_${teamId}`;
            const checkbox = document.getElementById(`team_${fullId}`);

            if (selectedTeams.has(fullId)) {
                selectedTeams.delete(fullId);
                antiSpoilerTeams.delete(fullId);
                if (checkbox) checkbox.checked = false;
            } else {
                selectedTeams.add(fullId);
                if (checkbox) checkbox.checked = true;
            }

            updateStats();
            applyFilters();
            loadKCFavorites();
        }

        // Toggle anti-spoiler for a team
        function toggleAntiSpoiler(league, teamId, event) {
            event.stopPropagation();
            const fullId = `${league.toUpperCase()}_${teamId}`;

            if (antiSpoilerTeams.has(fullId)) {
                antiSpoilerTeams.delete(fullId);
            } else {
                antiSpoilerTeams.add(fullId);
            }

            applyFilters();
            loadKCFavorites();
        }

        // Search teams
        function searchTeams() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            if (!query) {
                loadLeague(currentLeague);
                return;
            }

            const filtered = currentTeams.filter(team =>
                team.name.toLowerCase().includes(query) ||
                team.display_name.toLowerCase().includes(query) ||
                team.location.toLowerCase().includes(query) ||
                team.abbreviation.toLowerCase().includes(query)
            );

            renderTeams(filtered);
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalTeams').textContent =
                Object.values(allTeams).reduce((sum, league) =>
                    sum + (league.teams ? league.teams.length : 0), 0);

            // Count selected teams + ranking tokens
            let totalSelected = selectedTeams.size;
            Object.values(selectedRankings).forEach(rankings => {
                totalSelected += rankings.size;
            });
            document.getElementById('selectedCount').textContent = totalSelected;

            document.getElementById('leagueCount').textContent =
                Object.keys(allTeams).filter(k => k !== 'kc_favorites' && k !== '_metadata').length;
        }

        // Load KC Favorites
        function loadKCFavorites() {
            const favorites = allTeams.kc_favorites?.teams || [];

            const html = favorites.map(fav => {
                const teamId = `${fav.league.toUpperCase()}_${fav.team_id}`;
                const isSelected = selectedTeams.has(teamId);
                const isAntiSpoiler = antiSpoilerTeams.has(teamId);

                return `
                    <div class="kc-favorite-card ${isSelected ? 'selected' : ''}"
                         onclick="toggleKCFavorite('${fav.league}', '${fav.team_id}')">
                        <input type="checkbox"
                               id="kc_${teamId}"
                               ${isSelected ? 'checked' : ''}
                               onclick="event.stopPropagation()">
                        <label for="kc_${teamId}">${fav.display} (${fav.league})</label>
                        ${isSelected ? `
                            <div class="anti-spoiler-toggle ${isAntiSpoiler ? 'active' : ''}"
                                 style="margin-left: auto;"
                                 onclick="toggleAntiSpoiler('${fav.league}', '${fav.team_id}', event)">
                                <input type="checkbox"
                                       ${isAntiSpoiler ? 'checked' : ''}
                                       onclick="toggleAntiSpoiler('${fav.league}', '${fav.team_id}', event); event.stopPropagation()">
                                <span>üôà</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('kcFavorites').innerHTML = html;
        }

        // Toggle KC Favorite
        function toggleKCFavorite(league, teamId) {
            const fullId = `${league.toUpperCase()}_${teamId}`;
            const checkbox = document.getElementById(`kc_${fullId}`);

            if (selectedTeams.has(fullId)) {
                selectedTeams.delete(fullId);
                antiSpoilerTeams.delete(fullId);
                if (checkbox) checkbox.checked = false;
            } else {
                selectedTeams.add(fullId);
                if (checkbox) checkbox.checked = true;
            }

            updateStats();
            loadKCFavorites();

            if (currentLeague === league) {
                loadLeague(league);
            }
        }

        // Switch to soccer view
        function switchToSoccer() {
            document.querySelectorAll('.league-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            currentLeague = 'soccer';
            
            // Hide rankings for soccer
            document.getElementById('rankingsSection').classList.remove('visible');
            document.getElementById('filtersSection').style.display = 'none';

            if (soccerLoaded) {
                displaySoccerTeams();
            } else {
                document.getElementById('teamsContainer').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading soccer teams...</p>
                    </div>
                `;
                setTimeout(displaySoccerTeams, 500);
            }
        }

        // Display soccer teams
        function displaySoccerTeams() {
            if (!soccerLoaded || !soccerTeams.leagues) {
                document.getElementById('teamsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚öΩ</div>
                        <h3>Soccer teams loading...</h3>
                    </div>
                `;
                return;
            }

            let html = '<div style="margin-bottom: 20px;">';
            html += '<h3 style="margin-bottom: 15px;">‚öΩ Soccer Leagues</h3>';
            
            Object.entries(soccerTeams.leagues).forEach(([slug, league]) => {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #4a5568; margin-bottom: 10px;">${league.name} (${league.teams?.length || 0} teams)</h4>
                        <div class="teams-grid">
                `;
                
                (league.teams || []).forEach(team => {
                    const teamId = `SOCCER_${team.abbreviation}`;
                    const isSelected = selectedTeams.has(teamId);
                    const isAntiSpoiler = antiSpoilerTeams.has(teamId);
                    
                    html += `
                        <div class="team-card ${isSelected ? 'selected' : ''}"
                             onclick="toggleSoccerTeam('${slug}', '${team.abbreviation}')">
                            <input type="checkbox" id="team_${teamId}"
                                   ${isSelected ? 'checked' : ''}
                                   onclick="toggleSoccerTeam('${slug}', '${team.abbreviation}'); event.stopPropagation()">
                            <div class="team-info">
                                <div class="team-name">${team.short_name}</div>
                                <div class="team-details">${team.abbreviation}</div>
                            </div>
                            ${isSelected ? `
                                <div class="anti-spoiler-toggle ${isAntiSpoiler ? 'active' : ''}"
                                     onclick="toggleSoccerAntiSpoiler('${slug}', '${team.abbreviation}', event)">
                                    <input type="checkbox" ${isAntiSpoiler ? 'checked' : ''}
                                           onclick="toggleSoccerAntiSpoiler('${slug}', '${team.abbreviation}', event); event.stopPropagation()">
                                    <span>üôà</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            document.getElementById('teamsContainer').innerHTML = html;
        }

        // Toggle soccer team
        function toggleSoccerTeam(leagueSlug, teamAbbr) {
            const teamId = `SOCCER_${teamAbbr}`;
            const checkbox = document.getElementById(`team_${teamId}`);
            
            if (selectedTeams.has(teamId)) {
                selectedTeams.delete(teamId);
                antiSpoilerTeams.delete(teamId);
                if (checkbox) checkbox.checked = false;
            } else {
                selectedTeams.add(teamId);
                if (checkbox) checkbox.checked = true;
            }
            
            updateStats();
            displaySoccerTeams();
        }

        // Toggle soccer anti-spoiler
        function toggleSoccerAntiSpoiler(leagueSlug, teamAbbr, event) {
            event.stopPropagation();
            const teamId = `SOCCER_${teamAbbr}`;
            
            if (antiSpoilerTeams.has(teamId)) {
                antiSpoilerTeams.delete(teamId);
            } else {
                antiSpoilerTeams.add(teamId);
            }
            
            displaySoccerTeams();
        }

        // Save selection
        async function saveSelection() {
            // Build teams array including ranking tokens with league prefix
            const teamsArray = Array.from(selectedTeams);
            
            // Add ranking tokens with league prefix (e.g., NCAA_FB_AP_TOP_25)
            Object.keys(selectedRankings).forEach(league => {
                selectedRankings[league].forEach(token => {
                    teamsArray.push(`${league.toUpperCase()}_${token}`);
                });
            });
            
            const selection = {
                teams: teamsArray,
                anti_spoiler_teams: Array.from(antiSpoilerTeams),
                rankings: {
                    ncaa_fb: Array.from(selectedRankings.ncaa_fb || []),
                    ncaamb: Array.from(selectedRankings.ncaamb || []),
                    ncaawb: Array.from(selectedRankings.ncaawb || [])
                }
            };

            console.log('Saving selection:', selection);

            try {
                const response = await fetch('/api/teams/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(selection)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Save response:', data);
                    
                    // Count rankings
                    let rankingsCount = 0;
                    Object.values(selectedRankings).forEach(r => rankingsCount += r.size);
                    
                    const successMsg = document.getElementById('successMessage');
                    let msg = `‚úì Saved ${data.selected_count || selectedTeams.size} team${selectedTeams.size !== 1 ? 's' : ''}`;
                    if (rankingsCount > 0) {
                        msg += ` + ${rankingsCount} ranking filter${rankingsCount > 1 ? 's' : ''}`;
                    }
                    if (data.anti_spoiler_count > 0) {
                        msg += ` (${data.anti_spoiler_count} with anti-spoiler)`;
                    }
                    successMsg.textContent = msg;
                    successMsg.classList.add('show');
                    setTimeout(() => successMsg.classList.remove('show'), 5000);
                } else {
                    alert('Error saving. Please try again.');
                }
            } catch (error) {
                console.error('Error saving selection:', error);
                alert('Error saving selection. Please try again.');
            }
        }

        // Reset selection
        function resetSelection() {
            if (confirm('Are you sure you want to clear all selections?')) {
                selectedTeams.clear();
                antiSpoilerTeams.clear();
                // Clear all rankings
                Object.keys(selectedRankings).forEach(league => {
                    selectedRankings[league].clear();
                });
                
                // Save the empty selection
                saveSelection();
                
                // Refresh UI
                updateStats();
                updateRankingsCheckboxes();
                loadLeague(currentLeague);
                loadKCFavorites();
            }
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchTeams();
            }
        });
    </script>
</body>
</html>
